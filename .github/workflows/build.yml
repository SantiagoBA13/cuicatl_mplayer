name: Compilar Cuicatl

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Instalar Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - name: Instalar Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # --- INICIO DE TU CÓDIGO INTEGRADO ---
      - name: Flutter pub get
        run: flutter pub get

      - name: Create Android platform (if missing)
        run: |
          if [ ! -d "android" ]; then
            flutter create --platforms=android .
          fi

      - name: Force Android SDK 34 (compileSdk/targetSdk)
        run: |
          # build.gradle (Groovy)
          if [ -f "android/app/build.gradle" ]; then
            echo "Forzando SDK 34 en build.gradle..."
            sed -i 's/compileSdkVersion [0-9]\+/compileSdkVersion 34/g' android/app/build.gradle || true
            sed -i 's/targetSdkVersion [0-9]\+/targetSdkVersion 34/g' android/app/build.gradle || true
          fi

          # build.gradle.kts (Kotlin DSL - por si acaso)
          if [ -f "android/app/build.gradle.kts" ]; then
            sed -i 's/compileSdk = [0-9]\+/compileSdk = 34/g' android/app/build.gradle.kts || true
            sed -i 's/targetSdk = [0-9]\+/targetSdk = 34/g' android/app/build.gradle.kts || true
          fi

      - name: Patch AndroidManifest permissions (Android 14+)
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          if [ -f "$MANIFEST" ]; then
            echo "Parcheando Manifiesto..."
            
            # 1. INYECTAR PERMISOS (Tu lógica)
            if ! grep -q "android.permission.READ_MEDIA_AUDIO" "$MANIFEST"; then
              # Inserta antes de <application
              sed -i '/<application/ i\
      \
      <uses-permission android:name="android.permission.READ_MEDIA_AUDIO" />\
      \
      <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" android:maxSdkVersion="32" />\
      \
      <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />\
      \
      <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />\
      <uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK" />\
      ' "$MANIFEST"
            fi

            # 2. INYECTAR SERVICIO (Vital para que la app no crashee al reproducir)
            # Esto es necesario para la librería just_audio_background
            if ! grep -q "com.ryanheise.just_audio_background.AudioService" "$MANIFEST"; then
               sed -i 's/<\/application>/<service android:name="com.ryanheise.just_audio_background.AudioService" android:foregroundServiceType="mediaPlayback" android:exported="true" android:permission="android.permission.BIND_FOREGROUND_SERVICE_MEDIA_PLAYBACK"><intent-filter><action android:name="android.media.browse.MediaBrowserService" \/><\/intent-filter><\/service><\/application>/g' "$MANIFEST"
            fi
            
            # 3. Corregir nombre de actividad principal
            sed -i 's/android:name="io.flutter.app.FlutterApplication"/android:name="${applicationName}"/g' "$MANIFEST"
          fi
      # --- FIN DE TU CÓDIGO INTEGRADO ---

      - name: Construir APK
        run: flutter build apk --release --no-tree-shake-icons

      - name: Subir APK
        uses: actions/upload-artifact@v4
        with:
          name: cuicatl-app-v11-sdk34
          path: build/app/outputs/flutter-apk/app-release.apk
